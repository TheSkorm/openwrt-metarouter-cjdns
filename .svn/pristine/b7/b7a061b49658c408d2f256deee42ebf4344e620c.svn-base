#!/bin/sh
# Copyright (C) 2006-2011 OpenWrt.org

. /etc/functions.sh
[ $# = 0 ] && { echo "  $0 <group>"; exit; }

case "$1" in
	"-a")
		[ -e "/tmp/resolv.conf.auto" ] && rm /tmp/resolv.conf.auto
		config_cb() {
			[ interface != "$1" -o -z "$2" ] || eval "$0 -w $2"
		}
		config_load network
		exit 0
	;;
	"-w") shift ;;
esac

include /lib/network
scan_interfaces

cfg=$1
debug "### ifdown $cfg ###"

config_get proto "$cfg" proto
[ -z "$proto" ] && { echo "interface not found."; exit; }

config_get iface "$cfg" device
[ "static" = "$proto" -o "none" = "$proto" ] && {
	env -i ACTION="ifdown" INTERFACE="$cfg" DEVICE="$iface" PROTO="$proto" /sbin/hotplug-call "iface"
}

# call interface stop handler
( type "stop_interface_$proto" ) >/dev/null 2>/dev/null && eval "stop_interface_$proto '$cfg'"

config_get ifname "$cfg" ifname
config_get device "$cfg" device

[ ."$device" != ."$ifname" ] || device=
for dev in $ifname $device; do
	ifconfig "$dev" 0.0.0.0 down >/dev/null 2>/dev/null
done

config_get iftype "$cfg" type
[ "bridge" = "$iftype" ] && brctl delbr "$ifname" >/dev/null 2>/dev/null

# remove the interface's dns entries
remove_dns "$cfg"

# remove the interface's network state
uci_revert_state network "$1"

# revert aliases state as well
config_get aliases "$1" aliases
for config in $aliases; do
	uci_revert_state network "$config"
done
